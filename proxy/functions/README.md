# Gemini専用APIプロキシサーバー
VS Code拡張機能から安全にGemini APIを利用するための中継（プロキシ）サーバーです。  
APIキーの隠蔽に加え、ハッカソン展示での過剰な課金を防ぐためのアクセス制御を行っています。  

## 目次
- [Gemini専用APIプロキシサーバー](#gemini専用apiプロキシサーバー)
  - [目次](#目次)
  - [動作フロー](#動作フロー)
  - [特徴・工夫した点](#特徴工夫した点)
  - [使用技術](#使用技術)
  - [ローカルでの起動方法](#ローカルでの起動方法)

## 動作フロー
以下のようなフローで動くことを想定しています。

1. クライアント（VS Code拡張機能）から、プロンプトを含むHTTPリクエスト(POST)を受け取る。
2. リクエストヘッダー（`x-client-id` または `x-judge-token`）を検証し、**アクセス制限（レートリミット）**の判定を行う。
3. サーバー側で管理している環境変数（APIキー）を用いて、投げられたテキストをそのままGemini (`gemini-2.5-flash`) の入力とする。
4. Geminiからの生成結果を受け取り、アクセスしてきたクライアントに対して出力結果をそのまま投げる。

## 特徴・工夫した点
クライアント側にAPIキーを直接持たせないセキュリティ対策に加えて、以下のハッカソン特化の機能を実装しています。

- **クライアント単位の利用回数制限**  
  Firestore Databaseを利用し、1ユーザー（端末）につき最大5回までの利用制限を設けています。  
  これにより、展示時の想定外のAPIコールや無限ループによる過剰課金を防ぎます。
- **審査員向けバイパスモード (隠しコマンド)**  
  特定のリクエストヘッダー（`x-judge-token`）を含めてアクセスした場合は、制限を緩和してAPIを利用できる**特権ルート**を設けています。

## 使用技術
- **インフラ / バックエンド:** Cloud Functions for Firebase
- **データベース:** Firestore (回数制限のカウント保存用)
- **言語:** TypeScript (Node.js環境)
- **主要SDK:** `@google/generative-ai`

## ローカルでの起動方法
開発メンバーがローカルでサーバーを立ち上げる際の手順です。

1. パッケージのインストール
   ```bash
   cd proxy/functions
   npm install
2. 環境変数の設定
    functionsディレクトリ直下に .env ファイルを作成し、以下を設定してください。  
    ```bash
    GEMINI_API_KEY="取得したGeminiのAPIキー"  
    JUDGE_TOKEN="特権用のシークレットトークン"
    ```
3. エミュレータの起動
    ```Bash
    npm run serve
    ```
    ※事前に firebase login と、GCP上でのFirestoreデータベース（(default)）の作成が必要です。